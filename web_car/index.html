<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>测试</title>
    <script src="MiniAjax.js"></script>
    <script src="JsFileRead.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>
<input id="fileBtn" type="file" onchange="Update(this)" accept="image/*"/><br/>
<button onclick="OcrCarNum()">开始识别</button>
<div id="Result"></div>
<hr/>
<img id="p" src="" alt="" style="width:400px;height: auto;"/>
</body>
<script>
    let CarNumImage = null;

    function Update(input) {
        if (input.files.length > 0) {
            let jsFileRead = new JsFileRead(input.files[0], {
                load: function (result) {
                    document.querySelector("#p").src = result;
                    CarNumImage = result.split(";base64,",2)[1];
                    OcrCarNum();
                }
            });
            jsFileRead.step = 1024 * 1024 * 25;
            jsFileRead.readBlob();
        }
    }

    function OcrCarNum() {
        if (!CarNumImage) return;
        let ResultDiv = document.querySelector("#Result");
        ResultDiv.innerHTML = "正在进行识别";
        let miniAjax = new MiniAjax({
            url: "/CarNumOcr.json",
            type: "POST",
            data: JSON.stringify({
                image: CarNumImage
            }),
            contentType: "application/json; charset=utf-8",
            success: function (responseText, status) {
                let json = JSON.parse(responseText);
                if(json.error === 0){
                    if(json.message.length === 0){
                        ResultDiv.innerHTML = "未发现车牌";
                        return;
                    }
                    ResultDiv.innerHTML = "发现车牌：<br/>";
                    for(let i in json.message){
                        if(json.message.hasOwnProperty(i)){
                            let carNum = json.message[i];
                            ResultDiv.innerHTML += `&nbsp;&nbsp;&nbsp;&nbsp;${carNum.CarNum} : 准确度：${carNum.Result}<br/>`;
                        }
                    }
                }else {
                    ResultDiv.innerHTML = ResultDiv.message;
                }
            }
        });
        miniAjax.Send();
    }
</script>
</html>
